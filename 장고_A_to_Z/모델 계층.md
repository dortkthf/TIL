# 모델 계층

**목차**

- **모델** : [모델 소개](#모델-소개) | 필드 타입| 인덱스 | 메타 옵션 | 모델 클래스

- **쿼리셋** : 쿼리 실행 | 쿼리셋 메소드 | 룩업 표현식

- **모델 인스턴스** : 인스턴스 메소드 | 관련 객체에 접근하기

- **마이그레이션** : 마이그레이션 소개 | 연산자 레퍼런스 | 스키마에디터 | 마이그레이션 작성하기

- **심화** : 매니저 | Raw SQL | 트랜잭션 | 집계 | 검색 | 맞춤 필드 | 다중 데이터베이스 | 맞춤 룩업 | 쿼리 표현식 | 조건식 | 데이터베이스 함수

- **그외** : 지원되는 데이터베이스 | 레거시 데이터베이스 | 초기 데이터 제공 | 데이터베이스 접근 최적화 | PostgreSQL만의 기능

  

---



## 모델 소개

### 모델

모델은 데이터에 대한 단 하나의 정보의 소스.

모델은 저장하고 있는 데이터의 필수적인 필드와 동작을 포함

각각의 모델은 하나의 데이터베이스 테이블에 매핑

기본사항 :

- 각각의 모델은 파이썬의 클래스로, 하위 클래스인 django.db.model.Model 에 속한다.
- 모델의 각 속성은 데이터베이스 필드를 나타낸다.
- 장고는 자동으로 생성되는 데이터베이스-액세스 API를 실행해준다.

### 간단한 예제

이 모델은 **firtst_name**과 **last_name**을 가진 **Person**을 정의한다.

```python
from django.db import models

class Person(models.Model):
    first_name = models.CharField(max_length = 30)
    last_name = models.CharField(max_length = 30)
```

**first_name** 과 **last_name** 은 모델의 필드들로써 각 필드는 클래스 속성으로 지정되어 있으며, 각 속성은 각 데이터베이스의 열에 매핑됨

위의 **Person** 모델은 아래와 같이 데이터베이스 테이블을 생성함

```sql
CREATE TABLE myapp_person (
	'id' serial NOT NULL PRIMARY KEY,
    'first_name' varchar(30) NOT NULL,
    'last_name' varchar(30) NOT NULL
)
```

기술 참조사항:

- 테이블 이름인 myapp_person은 몇 모델들의 메타데이터에서 자동으로 도출되며 오버라이딩이 가능하다.

- id 필드는 자동으로 추가되나. 이 행위 역시 오버라이드 될 수 있다.
- 이 예제의 CREATE TABLE SQL 은 PostgreSQL 구문을 이용해 구성되었지만, 장고는 settings file 1 에서 지정된 데이터베이스 백엔드에 맞춘 SQL을 이용한다는 점에 주목할 만 한 가치가 있다.

### 모델 이용하기

모델을 정의한 후에는 장고에 이 모델을 이용할 것이라고 얘기해줘야 함

이는 설정(settings) 파일의 INSTALLED_APPS 를 바꾸면 되는데, models.py 를 포함하고있는 모듈의 이름을 추가하면 됨

예를 들어, 만약 앱을 위한 모델이 myapp.models 모듈에 있다면, 즉 manage.py startapp 1 를 통해 추가된 앱에 모델이 있다면 INSTALLED_APPS 가 부분적으로 읽어낸다

```python
INSTALLED_APPS = [
    'myapp',
]
```

만약 새로운 어플리케이션을 **settings:INSTALLED_APPS** 에 추가한다면 꼭 **manage.py migrate** 를 실행하고 필요하면 **manage.py makemigrations** 를 통해 먼저 마이그레이션 파일을 생성해라

### 필드

모델에서 가장 중요하고, 유일하게 필수적인 부분은 데이터베이스 필드 목록을 정의하는것

필드는 클래스 속성으로 정의됨.

**clean, save, delete** 같은 모델API와 충돌할 수 있는 단어를 필드 이름으로 사용하지 않도록 주의

```python
from django.db import models

class Musician(models.Model):
    first = models.CharField(max_length=50)
    last = models.CharField(max_length=50)
    instrument = models.Charfield(max_length=100)
    
class Album(models.Model):
    artist = models.ForeignKey(Musician,on_delete=models.CASCADE)
    name = models.CharField(max_length=100)
    release_date = models.DateField()
    num_stars = models.IntegerField()
```

### 필드 타입

모델의 각 필드는 적당한 Field 클래스의 인스턴스여야 함 장고는 필드 클래스 타입을 결정하는데 몇 가지 사항을 사용

- 데이터베이스에 어떤 자료형의 데이터를 저장하는지(예를 들어 INTEGER, VARCHAR, TEXT) 알려주는 컬럼 타입
- 폼 필드를 렌더링할때 사용해야 하는 디폴트 HTML 위젯(예를 들어, < input type='text'>, < select >)
- 장고 어드민과 자동 생성 폼에서 사용되는 최소한의 유효성 검증 요구사항

### 필드 유형

#### **AutoField**

자동으로 만들어주는 프라이머리 키이며 IntegerField 이다.

#### **BigAutoField**

AutoField와 비슷하며 AutoField와 다르게 1 부터 `9223372036854775807` 까지의 수를 지원함

#### **BigIntegerField**

기본 IntegerField와 비슷하며 IntegerField와는 다르게 이는 수 -9223372036854775808 에서부터9223372036854775807 까지이다 이필드의 디폴트 폼위젯은 NumberInput 이다.

#### **BinaryField**  

원시 이진 데이터를 저장하는 필드이다. bytes, bytearray 또는 memoryview를 할당할수 있다. 기본적으로 BinaryField는 편집 가능을 False로 설정하며 이 경우 ModelForm에 포함될 수 없다.

BinaryField 는 하나 속성을 가진다.

- BinaryField.max_length

#### **BooleanField**

참/거짓 필드.

이 필드의 기본 양식 위젯은 CheckboxInput 또는 null=True인 경우 NullBooleanSelect 이다.

Field.default 가 정의되지 않은 경우 BooleanField의 기본 값은 None 이다.

#### **CharField**

작은 문자열에서 큰 사이즈의 문자열을 위한 문자열 필드

많은 수의 텍스트를 사용할때는 TextField 를 사용해라

이 필드의 기본 양식 위젯은 TextInput 이다.

CharField는 두개의 속성을 가진다.

- CharField.max_length : 필수값으로써 필드의 최대길이를 정한다.
- CharField.db_collation : 필드의 데이터베이스 데이터 정렬 이름( 잘모르겠음 확인해봐야함)

#### **DateField**

이 필드는 파이썬에서 datetime.date 로 나타내어진다. 

이 필드는 몇개의 속성이 있다.

- DateField.auto_now : 
  - 개체가 저장될 때마다 자동으로 필드를 지금시간으로 설정한다.
  - 마지막으로 수정된 시간을 기록할때 유용하며 현재 날짜가 항상 사용된다.
  - 이 필드는 Model.save()를 호출할 때만 자동으로 업데이트된다.

- DateField.auto_now_add :
  - 개체가 처음 생성될때 필드를 지금으로 자동 설정합니다. 현재 날짜가 항상 사용된다. 재정의 할 수 있는 기본값이 아니다. 따라서 개체를 생성할때 이 필드에 값을 설정해도 무시된다.

기본 양식 위젯은 DateInput 이다.

#### **DateTimeField**

이 필드는 파이썬에서 datetime.datetime 으로 나타내어진다. DateField와 같은 속성을 가진다

- DateField.auto_now : 
  - 개체가 저장될 때마다 자동으로 필드를 지금시간으로 설정한다.
  - 마지막으로 수정된 시간을 기록할때 유용하며 현재 날짜가 항상 사용된다.
  - 이 필드는 Model.save()를 호출할 때만 자동으로 업데이트된다.

- DateField.auto_now_add :
  - 개체가 처음 생성될때 필드를 지금으로 자동 설정합니다. 현재 날짜가 항상 사용된다. 재정의 할 수 있는 기본값이 아니다. 따라서 개체를 생성할때 이 필드에 값을 설정해도 무시된다.

기본 양식 위젯은 DateTimeInput 이다.

#### **DecimalField**

파이썬에서 Decimal 인스턴스로 표현되는 고정 정밀도 십진수이다

DecimalValidator를 사용하여 입력의 유효성을 검사한다

두개의 속성을 반드시 필요로 한다.

- DecimalField.max_digits
  - 소수점을 포함한 숫자에 허용되는 최대 자릿수이다. 예를들어 999.00 이면 5
  - 이숫자는 반드시 decimal_places보다 크거나 같아야 한다.
- DecimalField.decimal_places
  - 숫자와 함께 저장할 소수자릿수 이다.

이 필드의 기본 양식 위젯은 localize가 False 인경우 NumberInput 이고 그렇지 않을 경우 TextInput 이다.

#### **DurationField**

기간을 저장하기 위한 필드로 timedelta로 파이썬에서 모델링됨

PostgreSQL에서 사용될 때 사용되는 데이터 유형은 interval 이다

Oracle 에서 데이터 유형은 INTERVAL DAY(9) TO SECOND(6) 이다

그렇지 않으면 마이크로초의 bigint가 사용된다.

- 참고:
  - DurationField를 사용한 산술 연산은 대부분의 경우에 작동한다. 그러나 PostgreSQL 이외의 모든 데이터베이스에서 DurationField 값을 DateTimeField 인스턴스의 산술과 비교하면 예상대로 작동하지 않는다

#### **EmailField**

EmailValidator를 사용하여 값이 유효한 이메일 주소인지 확인하는 CharField이다.

#### FileField

파일을 업로드하는 필드이다.

두개의 속성을 가진다.

- FileField.upload_to
  - 













